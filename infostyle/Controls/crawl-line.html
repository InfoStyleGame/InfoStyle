<polymer-element name="crawl-line">
    <template>
        <style>
            @-webkit-keyframes scroll {
                0% {
                    -webkit-transform: translate(0, 0);
                    transform: translate(0, 0);
                }

                100% {
                    -webkit-transform: translate(-100%, 0);
                    transform: translate(-100%, 0);
                }
            }

            @-moz-keyframes scroll {
                0% {
                    -moz-transform: translate(0, 0);
                    transform: translate(0, 0);
                }

                100% {
                    -moz-transform: translate(-100%, 0);
                    transform: translate(-100%, 0);
                }
            }

            @keyframes scroll {
                0% {
                    transform: translate(0, 0);
                }

                100% {
                    transform: translate(-100%, 0);
                }
            }

            .marquee {
                display: block;
                width: 1000px;
                font-size: 30px;
                white-space: nowrap;
                overflow: hidden;
            }

            .marquee .animateMarquee {
                display: inline-block;
                padding-left: 100%;
                -webkit-animation: scroll 40s linear;
                -moz-animation: scroll 40s linear;
                animation: scroll 40s linear;
            }
        </style>
        <div id="start">
            <paper-button on-tap="{{startGame}}">Начать</paper-button>
        </div>
        <div style="display:none" id="game" class="marquee" on-tap="{{clickAction}}">
            <div class="crawlLineCounters">
                <span>Баллы: <span id="points">{{points}}</span></span>
            </div>
            <div id="text">
             
            </div>
        </div>
        <div id="end" style="display:none;">
            <div>Всего стоп-слов: <span>{{stopWordsCount}}</span></div>
            <div>Вы угадали: <span>{{hits}}</span></div>
            <div>Штраф за промахи: <span>{{misses}}</span></div>
            <div>Итого баллов: <span>{{points}}</span></div>
            <div>
                <paper-button on-tap="{{endGame}}">Завершить</paper-button>
            </div>
        </div>
        
    </template>
    <script>
        Polymer({
            ready: function () {
            },

            startGame: function () {
                this.points = 0;
                this.hits = 0;
                this.misses = 0;
                $(this.$.start).hide();
                $(this.$.game).show();
                var self = this;

                Api.GetTask(TaskTypes.CrawlLine, Subjects.Stop).done(function (task) {
                    self.data = task.Data.Text;
                    self.taskId = task.Id;
                    self.init();
                    self.$.text.className = 'animateMarquee';
                    self.initAnimationEnd();
                });
                
            },

            endGame: function() {
                
            },

            initAnimationEnd: function () {

                function whichAnimationEvent() {
                    var t,
                        el = document.createElement("fakeelement");

                    var animations = {
                        "animation": "animationend",
                        "OAnimation": "oAnimationEnd",
                        "MozAnimation": "animationend",
                        "WebkitAnimation": "webkitAnimationEnd"
                    }

                    for (t in animations) {
                        if (el.style[t] !== undefined) {
                            return animations[t];
                        }
                    }
                }

                var text = this.$.text, animationEndEvent = whichAnimationEvent();
                text.addEventListener(animationEndEvent, onAnimationEnd);

                var self = this;
                function onAnimationEnd(event) {
                    text.removeEventListener(animationEndEvent, onAnimationEnd);
                    self.submitTaskResults();
                }

            },

            submitTaskResults: function() {
                $(this.$.game).hide();
                $(this.$.end).show();
                Api.SubmitTaskResults(this.points, this.taskId);
                // TODO submit results
            },

            init: function() {
                var text = this.$.text;
                this.stopWordsCount = 0;
                for (var i = 0; i < this.data.length; i++) {
                    var word = this.buildWord(this.data[i]);
                    text.appendChild(word);
                }
            },

            buildWord: function(datum) {
                if (datum.Type == TextTypes.Normal) {
                    return $("<span/>").text(datum.Text)[0];
                } else if (datum.Type == TextTypes.Stop) {
                    this.stopWordsCount++;
                    return $("<paper-button>/>").attr("on-tap", "{{clickAction}}").addClass("stopWord").text(datum.Text)[0];
                } else {
                    console.warn("Unknown text type" + datum.Type);
                    return $("<span/>")[0];
                }
            },

            clickAction: function(e) {
                var t = e.target;
                if (t.localName === 'paper-button') {
                    if (!e.target.hit) {
                        this.points++;
                        this.hits++;
                        e.target.hit = true;
                    }

                    
                } else {
                    this.points--;
                    this.misses++;
                }
            }
        });
</script>
</polymer-element>