<polymer-element name="ist-level" attributes="level">
    <link rel="import" href="/Scripts/polymer/paper-button/paper-button.html">
	<link rel="import" href="/Controls/crawl-line.html">
	<link rel="import" href="/Controls/cards-list.html">
	<link rel="import" href="/Controls/theory-block.html">
	<template>
        <style>
            :host /deep/ paper-button {
                text-transform: none;
            }

            :host /deep/ paper-button.action {
                font-size: 1.4em;
                font-family: "Lora";
                font-style: italic;
                margin: 20px 10px 20px 0;
            }

            :host /deep/ paper-button.action_next {
                background-color: #C48FFF;
                color: #fff;
            }

            :host /deep/ paper-button.action_back {
                border: solid 1px #C48FFF;
                color: #C48FFF;
                background-color: #fff;
            }
        </style>
        <theory-block level="{{level}}"></theory-block>
		<cards-list delayed="true" level="{{level}}" isActive="{{isCardsListActive}}"></cards-list>
		<crawl-line level="{{level}}" isActive="{{isCrawlLineActive}}"></crawl-line>
        <paper-button id="nextTaskButton" class="action action_next" hidden="true" on-tap="{{nextTask}}" raised>Дальше</paper-button>
        <paper-button id="goToMapButton" class="action action_back" hidden="true" on-tap="{{goToMap}}">Вернуться на карту</paper-button>
        <paper-button id="nextLevelButton" class="action action_next" hidden="true" on-tap="{{nextLevel}}">Следующий уровень</paper-button>
	</template>
    <script>
    	Polymer({
    		ready: function () {
    			this.totalScore = 0;
    			this.uncompletedTasks = [
                    "isCardsListActive",
                    "isCrawlLineActive"
                ];
                this.addEventListener('task-complete', this.onTaskComplete);

                this.nextTask();
    		},

            onTaskComplete: function(e) {
                // Сохраняем набранные за задание очки
                if (e && e.detail && e.detail.points) {
                    this.totalScore += e.detail.points;
                }

                // Показываем кнопку «Дальше», если есть незаконченное задание
                if (this.uncompletedTasks.length > 0) {
                    this.$["nextTaskButton"].hidden = false;
                } else {
                    // Показать «Вернуться на карту», если все задания пройдены
                    this.$["goToMapButton"].hidden = false;
                    this.$["nextLevelButton"].hidden = false;
                    this.submitTaskResult();
                }
            },

            nextTask: function() {
                // Скрыть кнопку «Дальше
                this.$["nextTaskButton"].hidden = true;
                
                // Скрыть завершенное задание
                if (this.inprogressTask)
                    this[this.inprogressTask] = false;

                // Взять следующее незаконченное задание и активировать его
                this.inprogressTask = this.uncompletedTasks.shift();
                this[this.inprogressTask] = true;
            },


            submitTaskResult: function() {
                Api.SubmitTaskResults(this.level, this.totalScore);
            },

            goToMap: function() {
                this.fire('goToMap');
            },

            nextLevel: function() {
                this.fire('nextLevel', { nextLevel: +this.level+1 });
            }
    	});
    </script>
</polymer-element>